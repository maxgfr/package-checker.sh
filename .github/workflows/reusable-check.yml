name: Reusable Package Vulnerability Check

on:
  workflow_call:
    inputs:
      use-ghsa:
        description: "Use built-in GHSA feed from the repository"
        required: false
        type: boolean
        default: false
      use-osv:
        description: "Use built-in OSV feed from the repository"
        required: false
        type: boolean
        default: false
      source:
        description: "Vulnerability source URL or path (JSON or CSV). For multiple sources, use the 'sources' input instead."
        required: false
        type: string
      sources:
        description: "Multiple vulnerability sources (one per line). Each line should be a URL or path. Takes precedence over 'source' input."
        required: false
        type: string
      source-format:
        description: "Format of the vulnerability source (json or csv, auto-detected if not specified)"
        required: false
        type: string
        default: ""
      csv-columns:
        description: 'CSV column mapping (e.g., "name,versions" or "1,2")'
        required: false
        type: string
        default: ""
      working-directory:
        description: "Working directory to scan (default: current directory)"
        required: false
        type: string
        default: "."
      fail-on-vulnerabilities:
        description: "Fail the workflow if vulnerabilities are found"
        required: false
        type: boolean
        default: true
      script-version:
        description: "Version or branch of the script to use (default: main)"
        required: false
        type: string
        default: "main"
      additional-args:
        description: "Additional arguments to pass to the script"
        required: false
        type: string
        default: ""
      only-package-json:
        description: "Scan only package.json files (skip lockfiles)"
        required: false
        type: boolean
        default: false
      only-lockfiles:
        description: "Scan only lockfiles (skip package.json files)"
        required: false
        type: boolean
        default: false
      lockfile-types:
        description: "Comma-separated list of lockfile types to scan (npm, yarn, pnpm, bun, deno)"
        required: false
        type: string
        default: ""
    secrets:
      github-token:
        description: "GitHub token for accessing private repositories (optional)"
        required: false

jobs:
  check-vulnerabilities:
    name: Check for Vulnerable Packages
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download package-checker script
        run: |
          curl -sS https://raw.githubusercontent.com/maxgfr/package-checker.sh/${{ inputs.script-version }}/script.sh -o package-checker.sh
          chmod +x package-checker.sh

      - name: Run vulnerability check
        id: vuln-check
        working-directory: ${{ inputs.working-directory }}
        env:
          GITHUB_TOKEN: ${{ secrets.github-token }}
        run: |
          ARGS=""
          GHSA_URL="https://raw.githubusercontent.com/maxgfr/package-checker.sh/main/data/ghsa.purl"
          OSV_URL="https://raw.githubusercontent.com/maxgfr/package-checker.sh/main/data/osv.purl"

          # Add built-in GHSA feed if requested
          if [ "${{ inputs.use-ghsa }}" = "true" ]; then
            echo "Using built-in GHSA feed"
            ARGS="$ARGS --source $GHSA_URL"
          fi

          # Add built-in OSV feed if requested
          if [ "${{ inputs.use-osv }}" = "true" ]; then
            echo "Using built-in OSV feed"
            ARGS="$ARGS --source $OSV_URL"
          fi

          # Handle multiple sources via 'sources' input
          if [ -n "${{ inputs.sources }}" ]; then
            echo "Using multiple sources from 'sources' input"
            while IFS= read -r source_url; do
              # Skip empty lines
              if [ -n "$source_url" ]; then
                ARGS="$ARGS --source $source_url"
              fi
            done <<< "${{ inputs.sources }}"
          fi

          # Handle single 'source' input
          if [ -n "${{ inputs.source }}" ]; then
            echo "Using single source from 'source' input"
            ARGS="$ARGS --source ${{ inputs.source }}"
          fi

          # Check if at least one source was provided
          if [ -z "$ARGS" ]; then
            echo "Error: No vulnerability source provided. Use one of:"
            echo "  - use-ghsa: true"
            echo "  - use-osv: true"
            echo "  - source: <url-or-path>"
            echo "  - sources: <multiple-urls-or-paths>"
            exit 1
          fi

          if [ -n "${{ inputs.source-format }}" ]; then
            ARGS="$ARGS --format ${{ inputs.source-format }}"
          fi

          if [ -n "${{ inputs.csv-columns }}" ]; then
            ARGS="$ARGS --csv-columns ${{ inputs.csv-columns }}"
          fi

          # Add file type filtering flags
          if [ "${{ inputs.only-package-json }}" = "true" ]; then
            echo "Scanning only package.json files"
            ARGS="$ARGS --only-package-json"
          fi

          if [ "${{ inputs.only-lockfiles }}" = "true" ]; then
            echo "Scanning only lockfiles"
            ARGS="$ARGS --only-lockfiles"
          fi

          if [ -n "${{ inputs.lockfile-types }}" ]; then
            echo "Filtering lockfile types: ${{ inputs.lockfile-types }}"
            ARGS="$ARGS --lockfile-types ${{ inputs.lockfile-types }}"
          fi

          if [ -n "${{ inputs.additional-args }}" ]; then
            ARGS="$ARGS ${{ inputs.additional-args }}"
          fi

          echo "Running: $GITHUB_WORKSPACE/package-checker.sh $ARGS"

          if [ "${{ inputs.fail-on-vulnerabilities }}" = "true" ]; then
            $GITHUB_WORKSPACE/package-checker.sh $ARGS
          else
            $GITHUB_WORKSPACE/package-checker.sh $ARGS || echo "Vulnerabilities found but not failing the build"
          fi

      - name: Upload results (if available)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-scan-results
          path: |
            **/package-checker-results.txt
            **/vulnerability-report.json
          if-no-files-found: ignore
