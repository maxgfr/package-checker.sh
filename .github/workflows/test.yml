name: Test Package Checker

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test-fixtures:
    name: Run Tests on Fixtures
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make script executable
        run: chmod +x script.sh

      - name: Run all tests
        run: |
          set +e  # Don't exit on first error
          FAILED_TESTS=0
          PASSED_TESTS=0

          echo "=========================================="
          echo "Running Package Checker Tests"
          echo "=========================================="
          echo ""

          # Test npm project
          echo "üì¶ Testing npm project..."
          cd test-fixtures/npm-project
          ../../script.sh --source ../test-vulnerabilities.json
          if [ $? -eq 1 ]; then
            echo "‚úÖ npm project: Found vulnerabilities as expected"
            PASSED_TESTS=$((PASSED_TESTS + 1))
          else
            echo "‚ùå npm project: Should have found vulnerabilities"
            FAILED_TESTS=$((FAILED_TESTS + 1))
          fi
          cd ../..
          echo ""

          # Test yarn project
          echo "üì¶ Testing yarn project..."
          cd test-fixtures/yarn-project
          ../../script.sh --source ../test-vulnerabilities.json
          if [ $? -eq 1 ]; then
            echo "‚úÖ yarn project: Found vulnerabilities as expected"
            PASSED_TESTS=$((PASSED_TESTS + 1))
          else
            echo "‚ùå yarn project: Should have found vulnerabilities"
            FAILED_TESTS=$((FAILED_TESTS + 1))
          fi
          cd ../..
          echo ""

          # Test yarn berry project
          echo "üì¶ Testing yarn berry project..."
          cd test-fixtures/yarn-berry-project
          ../../script.sh --source ../test-vulnerabilities.json
          if [ $? -eq 1 ]; then
            echo "‚úÖ yarn berry project: Found vulnerabilities as expected"
            PASSED_TESTS=$((PASSED_TESTS + 1))
          else
            echo "‚ùå yarn berry project: Should have found vulnerabilities"
            FAILED_TESTS=$((FAILED_TESTS + 1))
          fi
          cd ../..
          echo ""

          # Test pnpm project
          echo "üì¶ Testing pnpm project..."
          cd test-fixtures/pnpm-project
          ../../script.sh --source ../test-vulnerabilities.json
          if [ $? -eq 1 ]; then
            echo "‚úÖ pnpm project: Found vulnerabilities as expected"
            PASSED_TESTS=$((PASSED_TESTS + 1))
          else
            echo "‚ùå pnpm project: Should have found vulnerabilities"
            FAILED_TESTS=$((FAILED_TESTS + 1))
          fi
          cd ../..
          echo ""

          # Test bun project
          echo "üì¶ Testing bun project..."
          cd test-fixtures/bun-project
          ../../script.sh --source ../test-vulnerabilities.json
          if [ $? -eq 1 ]; then
            echo "‚úÖ bun project: Found vulnerabilities as expected"
            PASSED_TESTS=$((PASSED_TESTS + 1))
          else
            echo "‚ùå bun project: Should have found vulnerabilities"
            FAILED_TESTS=$((FAILED_TESTS + 1))
          fi
          cd ../..
          echo ""

          # Test deno project
          echo "üì¶ Testing deno project..."
          cd test-fixtures/deno-project
          ../../script.sh --source ../test-vulnerabilities.json
          if [ $? -eq 1 ]; then
            echo "‚úÖ deno project: Found vulnerabilities as expected"
            PASSED_TESTS=$((PASSED_TESTS + 1))
          else
            echo "‚ùå deno project: Should have found vulnerabilities"
            FAILED_TESTS=$((FAILED_TESTS + 1))
          fi
          cd ../..
          echo ""

          # Test npm-shrinkwrap project
          echo "üì¶ Testing npm-shrinkwrap project..."
          cd test-fixtures/npm-shrinkwrap-project
          ../../script.sh --source ../test-vulnerabilities.json
          if [ $? -eq 1 ]; then
            echo "‚úÖ npm-shrinkwrap project: Found vulnerabilities as expected"
            PASSED_TESTS=$((PASSED_TESTS + 1))
          else
            echo "‚ùå npm-shrinkwrap project: Should have found vulnerabilities"
            FAILED_TESTS=$((FAILED_TESTS + 1))
          fi
          cd ../..
          echo ""

          # Test monorepo
          echo "üì¶ Testing monorepo..."
          cd test-fixtures/monorepo
          ../../script.sh --source ../test-vulnerabilities.json
          if [ $? -eq 1 ]; then
            echo "‚úÖ monorepo: Found vulnerabilities as expected"
            PASSED_TESTS=$((PASSED_TESTS + 1))
          else
            echo "‚ùå monorepo: Should have found vulnerabilities"
            FAILED_TESTS=$((FAILED_TESTS + 1))
          fi
          cd ../..
          echo ""

          # Test safe project (should NOT find vulnerabilities)
          echo "üì¶ Testing safe project (should pass)..."
          cd test-fixtures/safe-project
          ../../script.sh --source ../test-vulnerabilities.json
          if [ $? -eq 0 ]; then
            echo "‚úÖ safe project: No vulnerabilities found as expected"
            PASSED_TESTS=$((PASSED_TESTS + 1))
          else
            echo "‚ùå safe project: Should NOT have found vulnerabilities"
            FAILED_TESTS=$((FAILED_TESTS + 1))
          fi
          cd ../..
          echo ""

          # Test with CSV source
          echo "üì¶ Testing with CSV source..."
          cd test-fixtures/npm-project
          ../../script.sh --source ../test-vulnerabilities.csv
          if [ $? -eq 1 ]; then
            echo "‚úÖ CSV source: Found vulnerabilities as expected"
            PASSED_TESTS=$((PASSED_TESTS + 1))
          else
            echo "‚ùå CSV source: Should have found vulnerabilities"
            FAILED_TESTS=$((FAILED_TESTS + 1))
          fi
          cd ../..
          echo ""

          # Test with config file
          echo "üì¶ Testing with config file..."
          cd test-fixtures
          ../script.sh --config .package-checker.config.json
          if [ $? -eq 1 ]; then
            echo "‚úÖ Config file: Found vulnerabilities as expected"
            PASSED_TESTS=$((PASSED_TESTS + 1))
          else
            echo "‚ùå Config file: Should have found vulnerabilities"
            FAILED_TESTS=$((FAILED_TESTS + 1))
          fi
          cd ..
          echo ""

          # Summary
          echo "=========================================="
          echo "Test Summary"
          echo "=========================================="
          echo "‚úÖ Passed: $PASSED_TESTS"
          echo "‚ùå Failed: $FAILED_TESTS"
          echo "=========================================="

          if [ $FAILED_TESTS -gt 0 ]; then
            echo "Some tests failed!"
            exit 1
          else
            echo "All tests passed!"
            exit 0
          fi
