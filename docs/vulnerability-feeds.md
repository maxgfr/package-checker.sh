# Vulnerability PURL Feed Generation

The package-checker.sh script includes built-in functions to automatically fetch PURL-based vulnerability feeds for the npm ecosystem from OSV and GitHub Security Advisory (GHSA) data.

## Overview

**ğŸ“¦ Local data sources included**: This repository includes pre-generated vulnerability feeds that are automatically updated every 12 hours via GitHub Actions. You can use these local feeds directly without fetching anything!

These integrated feed fetchers produce normalized vulnerability feeds in [PURL format](https://github.com/package-url/purl-spec) for consumption by dependency scanners, policy engines, CI/CD pipelines, and offline environments.

**What this provides:**

- **Pre-generated local feeds** ready to use (located in `data/` directory)
- Automated feed fetching from upstream vulnerability databases
- Normalized PURL format output
- No external dependencies beyond standard Unix tools
- Can be automated via GitHub Actions

**What this is NOT:**
- A vulnerability scanner (use the main script.sh functionality for scanning)
- A CVE database
- A replacement for OSV, GHSA, or NVD

## Feed Format

Each vulnerability is represented as a PURL (Package URL) with version constraints and query parameters:

```
pkg:npm/<package-name>@<vulnerable-version-range>?severity=<level>&ghsa=<id>&cve=<id>&source=<osv|ghsa>
```

### Examples

```
pkg:npm/lodash@>=0 <4.17.21?severity=high&ghsa=GHSA-xxxx-xxxx-xxxx&cve=CVE-2021-12345&source=osv
pkg:npm/axios@<0.21.2?severity=critical&ghsa=GHSA-yyyy-yyyy-yyyy&source=ghsa
pkg:npm/express@>=4.0.0 <4.17.1?severity=moderate&cve=CVE-2020-54321&source=osv
pkg:npm/debug@<2.6.9?severity=unknown&source=ghsa
```

### Query Parameters

- `severity`: Vulnerability severity level (lowercase)
  - `critical`: CVSS score >= 9.0
  - `high`: CVSS score >= 7.0
  - `moderate`: CVSS score >= 4.0
  - `low`: CVSS score < 4.0
  - `unknown`: No severity information available
- `ghsa`: GitHub Security Advisory ID (if available)
- `cve`: CVE identifier (if available)
- `source`: Data source (`osv` or `ghsa`)

> Notes: Only npm ecosystem entries are included. Multiple vulnerable ranges produce multiple PURL entries; all available metadata is added as query parameters. Output is sorted and deduplicated for stability.

## Data Sources

### OSV (Open Source Vulnerabilities)
- Source: https://osv-vulnerabilities.storage.googleapis.com/npm/all.zip
- Ecosystem: npm only
- No authentication required

### GitHub Advisory Database
- Source: https://github.com/github/advisory-database
- Ecosystem: npm only
- No authentication required

## Usage

### Using Pre-Generated Local Feeds (Recommended)

The repository includes pre-generated feeds that are automatically kept up-to-date:

```bash
# Use the local GHSA feed directly
package-checker --source data/ghsa.purl

# Use both local feeds for comprehensive scanning
package-checker --source data/osv.purl --source data/ghsa.purl

# Check a specific package against local GHSA data
package-checker --package-name lodash --package-version 4.17.20 --source data/ghsa.purl
```

### Fetch All Feeds

Fetch both OSV and GHSA feeds at once:

```bash
# Fetch feeds to the data directory
package-checker --fetch-all data
```

This will create:

- `data/osv.purl` - Vulnerabilities from OSV
- `data/ghsa.purl` - Vulnerabilities from GHSA

### Fetch Individual Feeds

Fetch OSV data only:

```bash
package-checker --fetch-osv data/osv.purl
```

Fetch GHSA data only:

```bash
package-checker --fetch-ghsa data/ghsa.purl
```

### Using Feeds with package-checker.sh

Once you have the feeds (either pre-generated or freshly fetched), use them for scanning:

```bash
# Scan a project using the GHSA feed
package-checker --source data/ghsa.purl

# Scan using both feeds
package-checker --source data/osv.purl --source data/ghsa.purl

# Scan GitHub organization using generated feeds
package-checker --github-org your-org --source data/ghsa.purl
```

## Automated Updates with GitHub Actions

The repository includes a GitHub Actions workflow that automatically updates feeds every 12 hours.

**Workflow details:**
- **Schedule**: Runs automatically twice daily (00:00 and 12:00 UTC)
- **Duration**: ~7-10 minutes per run
- **Smart commits**: Only commits when vulnerabilities change
- **Statistics**: Each commit includes vulnerability counts
- **Timeout**: 30 minutes maximum (prevents hanging)

**Manual trigger:**
1. Go to the "Actions" tab in your GitHub repository
2. Select "Update Vulnerability Feeds" workflow
3. Click "Run workflow" button
4. Choose the branch and click "Run workflow"

**Monitoring:**
- Check the Actions tab for workflow run history
- Commit messages include statistics (OSV count, GHSA count, total)
- Failed runs will appear in red and send notifications (if configured)

## Performance

### Processing Speed

**OSV Feed Generation:**
- Downloads: ~196 MB zip file
- Processes: ~213,000 JSON files
- Parallel workers: 8 concurrent jq processes
- Runtime: ~5-7 minutes
- Output: ~206,000+ vulnerabilities

**GHSA Feed Generation:**
- Git clone: Sparse checkout (reviewed advisories only)
- Processes: ~25,000 JSON files
- Sequential processing with progress indicators
- Runtime: ~2-3 minutes
- Output: ~5,000+ vulnerabilities

**Total Runtime:** ~7-10 minutes for complete feed generation

### Optimization Techniques

1. **Parallel Processing**: OSV uses `xargs -P 8` for 8-way parallel jq execution
2. **Sparse Checkout**: GHSA only downloads reviewed advisories, not entire repository
3. **Shallow Clone**: Git operations use `--depth 1` for minimal data transfer
4. **Streaming**: All processing uses pipes and avoids intermediate files
5. **Deduplicated Output**: `sort -u` ensures no duplicate PURLs

## Requirements

Standard Unix tools (all available on GitHub Actions runners):
- `bash`
- `curl`
- `jq`
- `git`
- `unzip`

No additional dependencies, API keys, or secrets needed.

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OSV.dev    â”‚         â”‚  GitHub Advisory DB  â”‚
â”‚  (npm data) â”‚         â”‚  (npm advisories)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                           â”‚
       â”‚                           â”‚
       â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Fetch & Normalize (PURL generation)       â”‚
â”‚  - Parse JSON vulnerability data           â”‚
â”‚  - Extract package + version ranges        â”‚
â”‚  - Convert to pkg:npm/<name>@<range>       â”‚
â”‚  - Sort and deduplicate                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  PURL Feeds   â”‚
         â”‚  osv.purl     â”‚
         â”‚  ghsa.purl    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Design Principles

- **No external dependencies** - Uses only standard Unix tools
- **No secrets** - All data sources are public
- **Deterministic** - Same input produces same output
- **Idempotent** - Running twice produces identical results
- **Fail fast** - Errors stop execution immediately
- **Latest only** - Feeds represent current upstream state, not historical append

## Use Cases

These feeds are designed for:

- Custom dependency scanners
- Policy engines
- CI/CD vulnerability checks
- Offline/air-gapped environments
- Integration with existing security tools
- Maintaining up-to-date vulnerability databases

## Integration Example

Here's a complete example workflow:

```bash
#!/bin/bash

# Option 1: Use pre-generated local feeds (recommended)
echo "Scanning with local feeds..."
package-checker --source data/ghsa.purl --source data/osv.purl

# Option 2: Fetch fresh feeds if you need the absolute latest data
echo "Fetching latest vulnerability feeds..."
package-checker --fetch-all data

# 3. Scan current project using feeds
echo "Scanning current project..."
package-checker --source data/ghsa.purl --source data/osv.purl

# 4. Scan a specific package
echo "Checking lodash package..."
package-checker --package-name lodash --package-version 4.17.0 --source data/ghsa.purl

# 5. Scan GitHub organization
echo "Scanning GitHub organization..."
package-checker --github-org myorg --source data/ghsa.purl --github-token $GITHUB_TOKEN
```

## Feed Statistics

Current typical feed sizes (varies as new vulnerabilities are published):
- **OSV**: ~206,000+ npm vulnerabilities
- **GHSA**: ~5,000+ npm vulnerabilities
- **Total**: ~211,000+ unique vulnerability entries

## Related Documentation

- [Main README](../README.md) - Overall project documentation
- [Configuration Guide](configuration.md) - How to configure package-checker.sh
- [Data Formats](data-formats.md) - Supported vulnerability data formats
- [CI/CD Integration](ci.md) - Using in continuous integration
